<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Strain - Evergreen Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .preview-box {
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .copy-success {
            background: #10b981 !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <header class="bg-green-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Evergreen Admin</h1>
            <p class="mt-2">Add New Strain</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white rounded-lg shadow-md p-8">
            <!-- Strain Name -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" for="strainName">Strain Name</label>
                <input type="text" id="strainName" placeholder="e.g. Blue Dream"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>

            <!-- Product Form -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" for="productForm">Product Form</label>
                <select id="productForm"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="flower">Flower</option>
                    <option value="crumble">Crumble</option>
                    <option value="caps">Snow Caps</option>
                </select>
            </div>

            <!-- Strain Type -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" for="strainType">Strain Type</label>
                <select id="strainType"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="indica">Indica</option>
                    <option value="sativa">Sativa</option>
                    <option value="hybrid">Hybrid</option>
                </select>
            </div>

            <!-- COA File -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" for="coaFile">COA File</label>
                <input type="file" id="coaFile" accept=".pdf,.jpg,.jpeg,.png,.heic"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>

            <!-- Snow Caps COA (conditional) -->
            <div class="mb-6 hidden" id="capsCoaSection">
                <label class="block text-sm font-semibold text-gray-700 mb-2" for="capsCoaFile">
                    Snow Caps COA File
                    <span class="font-normal text-gray-500">(defaults to SnowCaps-iso.pdf if not uploaded)</span>
                </label>
                <input type="file" id="capsCoaFile" accept=".pdf,.jpg,.jpeg,.png,.heic"
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
        </div>

        <!-- Live Preview -->
        <div class="mt-8 hidden" id="previewSection">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Preview</h2>

            <!-- Filename Preview -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                <p class="text-sm font-semibold text-gray-600 mb-1">Generated Filename</p>
                <p class="text-lg font-mono text-green-700" id="filenamePreview"></p>
                <p class="text-sm font-mono text-green-600 mt-1 hidden" id="capsFilenamePreview"></p>
            </div>

            <!-- JS Entry Preview -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                <p class="text-sm font-semibold text-gray-600 mb-2">JavaScript Product Entry</p>
                <div class="preview-box" id="jsEntryPreview"></div>
                <button id="copyBtn"
                    class="mt-3 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors">
                    Copy Code
                </button>
            </div>

            <!-- Download Button -->
            <div class="flex gap-3">
                <button id="downloadBtn"
                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    Download Renamed COA File
                </button>
                <button id="downloadCapsBtn"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold hidden">
                    Download Caps COA File
                </button>
            </div>
        </div>
    </main>

    <script>
        const strainNameInput = document.getElementById('strainName');
        const productFormSelect = document.getElementById('productForm');
        const strainTypeSelect = document.getElementById('strainType');
        const coaFileInput = document.getElementById('coaFile');
        const capsCoaFileInput = document.getElementById('capsCoaFile');
        const capsCoaSection = document.getElementById('capsCoaSection');
        const previewSection = document.getElementById('previewSection');
        const filenamePreview = document.getElementById('filenamePreview');
        const capsFilenamePreview = document.getElementById('capsFilenamePreview');
        const jsEntryPreview = document.getElementById('jsEntryPreview');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadCapsBtn = document.getElementById('downloadCapsBtn');

        function toKebabCase(str) {
            return str
                .toLowerCase()
                .replace(/['']/g, '')           // remove apostrophes
                .replace(/[&#]/g, '')            // remove & and #
                .replace(/[^a-z0-9]+/g, '-')    // replace non-alphanumeric with hyphens
                .replace(/-+/g, '-')             // collapse consecutive hyphens
                .replace(/^-|-$/g, '');           // strip leading/trailing hyphens
        }

        function getFileExtension(file) {
            if (!file) return 'pdf';
            const name = file.name;
            const ext = name.substring(name.lastIndexOf('.') + 1).toLowerCase();
            return ext || 'pdf';
        }

        function generateFilename() {
            const name = strainNameInput.value.trim();
            if (!name) return null;

            const kebab = toKebabCase(name);
            const ext = getFileExtension(coaFileInput.files[0]);
            const form = productFormSelect.value;

            if (form === 'crumble') {
                return `crumble_${kebab}.${ext}`;
            }
            return `${kebab}.${ext}`;
        }

        function generateCapsFilename() {
            if (capsCoaFileInput.files[0]) {
                const ext = getFileExtension(capsCoaFileInput.files[0]);
                const name = strainNameInput.value.trim();
                const kebab = toKebabCase(name);
                return `caps_${kebab}.${ext}`;
            }
            return 'SnowCaps-iso.pdf';
        }

        function generateJsEntry() {
            const name = strainNameInput.value.trim();
            if (!name) return '';

            const form = productFormSelect.value;
            const type = strainTypeSelect.value;
            const filename = generateFilename();

            if (form === 'flower') {
                return `{ name: "${name}", file: "${filename}", type: "${type}" }`;
            }

            if (form === 'crumble') {
                return `{ name: "${name} Crumble", file: "${filename}", type: "crumble", strain: "${type}" }`;
            }

            if (form === 'caps') {
                const capsFile = generateCapsFilename();
                return `{ name: "${name} CAPS", file: "${filename}", file2: "${capsFile}", type: "caps", strain: "${type}" }`;
            }

            return '';
        }

        function updatePreview() {
            const name = strainNameInput.value.trim();
            const file = coaFileInput.files[0];
            const form = productFormSelect.value;

            if (!name) {
                previewSection.classList.add('hidden');
                return;
            }

            previewSection.classList.remove('hidden');
            previewSection.classList.add('fade-in');

            const filename = generateFilename();
            filenamePreview.textContent = filename;

            if (form === 'caps') {
                capsFilenamePreview.textContent = 'Caps COA: ' + generateCapsFilename();
                capsFilenamePreview.classList.remove('hidden');
            } else {
                capsFilenamePreview.classList.add('hidden');
            }

            jsEntryPreview.textContent = generateJsEntry();

            // Show/hide download buttons based on file availability
            downloadBtn.disabled = !file;
            downloadBtn.classList.toggle('opacity-50', !file);
            downloadBtn.classList.toggle('cursor-not-allowed', !file);

            if (form === 'caps') {
                downloadCapsBtn.classList.remove('hidden');
                const hasCapsFile = capsCoaFileInput.files[0];
                downloadCapsBtn.disabled = !hasCapsFile;
                downloadCapsBtn.classList.toggle('opacity-50', !hasCapsFile);
                downloadCapsBtn.classList.toggle('cursor-not-allowed', !hasCapsFile);
            } else {
                downloadCapsBtn.classList.add('hidden');
            }
        }

        // Show/hide Snow Caps COA section
        productFormSelect.addEventListener('change', () => {
            if (productFormSelect.value === 'caps') {
                capsCoaSection.classList.remove('hidden');
            } else {
                capsCoaSection.classList.add('hidden');
            }
            updatePreview();
        });

        // Live preview on any input change
        strainNameInput.addEventListener('input', updatePreview);
        strainTypeSelect.addEventListener('change', updatePreview);
        coaFileInput.addEventListener('change', updatePreview);
        capsCoaFileInput.addEventListener('change', updatePreview);

        // Copy to clipboard
        copyBtn.addEventListener('click', () => {
            const entry = generateJsEntry();
            navigator.clipboard.writeText(entry).then(() => {
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copy-success');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy Code';
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            });
        });

        // Download renamed COA file
        downloadBtn.addEventListener('click', () => {
            const file = coaFileInput.files[0];
            if (!file) return;

            const filename = generateFilename();
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Download renamed Caps COA file
        downloadCapsBtn.addEventListener('click', () => {
            const file = capsCoaFileInput.files[0];
            if (!file) return;

            const filename = generateCapsFilename();
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>
